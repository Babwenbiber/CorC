package de.tu_bs.cs.isf.cbc.tool.model;

import java.io.IOException;
import java.util.Collections;
import java.util.Map;

import org.eclipse.core.resources.IResource;
import org.eclipse.core.resources.IWorkspaceRoot;
import org.eclipse.core.resources.ResourcesPlugin;
import org.eclipse.core.runtime.CoreException;
import org.eclipse.emf.common.util.URI;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.ResourceSet;
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
import org.eclipse.emf.ecore.xmi.impl.XMIResourceFactoryImpl;
import org.eclipse.graphiti.mm.pictograms.Diagram;

import de.tu_bs.cs.isf.cbc.model.cbcmodel.CbCFormula;
import de.tu_bs.cs.isf.cbc.model.cbcmodel.CbcmodelPackage;
import de.tu_bs.cs.isf.cbc.model.cbcmodel.Method;

public class CbcModelUtil {
	
	public static void saveFormulaToModelFile(final CbCFormula formula, final Diagram d) throws CoreException, IOException {
		URI uri = d.eResource().getURI();
		uri = uri.trimFragment();
		uri = uri.trimFileExtension();
		uri = uri.appendFileExtension("cbcmodel");
		ResourceSet rSet = d.eResource().getResourceSet();
		final IWorkspaceRoot workspaceRoot = ResourcesPlugin.getWorkspace().getRoot();
		IResource file = workspaceRoot.findMember(uri.toPlatformString(true));
		if (file == null || !file.exists()) {
			Resource createResource = rSet.createResource(uri);
			createResource.save(Collections.emptyMap());
			createResource.setTrackingModification(true);
			final Resource resource = rSet.getResource(uri, true);
			resource.getContents().add(formula);
//			((CbCFormula) resource.getContents().get(0)).setName(d.getName());
		} else {
			final Resource resource = rSet.getResource(uri, true);
			resource.getContents().add(formula);
		}
	}
	
	public static void saveMethodToModelFile(final Method method, final Diagram d) throws CoreException, IOException {
		URI uri = d.eResource().getURI();
		uri = uri.trimFragment();
		uri = uri.trimFileExtension();
		uri = uri.appendFileExtension("cbcmodel");
		ResourceSet rSet = d.eResource().getResourceSet();
		final IWorkspaceRoot workspaceRoot = ResourcesPlugin.getWorkspace().getRoot();
		IResource file = workspaceRoot.findMember(uri.toPlatformString(true));
		if (file == null || !file.exists()) {
			Resource createResource = rSet.createResource(uri);
			createResource.save(Collections.emptyMap());
			createResource.setTrackingModification(true);
			final Resource resource = rSet.getResource(uri, true);
			resource.getContents().add(method);
		} else {
			final Resource resource = rSet.getResource(uri, true);
			resource.getContents().add(method);
		}
	}
	
	public static CbCFormula readFormula(URI uri) {
		CbcmodelPackage.eINSTANCE.eClass();
		Resource.Factory.Registry reg = Resource.Factory.Registry.INSTANCE;
		Map<String, Object> m = reg.getExtensionToFactoryMap();
		m.put("cbcmodel", new XMIResourceFactoryImpl());
		ResourceSet rs = new ResourceSetImpl();
		Resource r = rs.getResource(uri, true);
		CbCFormula formula = (CbCFormula) r.getContents().get(0);
		return formula;
	}
}
